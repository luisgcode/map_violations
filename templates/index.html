<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAP Violation Email Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <!-- Luis GCode Design System - Modular CSS Architecture -->
  </head>
  <body>
    <div class="container">
      <div class="creator-sign">Created by Marketing Team - <b> Luis Guaiquirian</b></div>
      <div class="header">
        <h1>
          MAP Violation Email Generator
          <span id="currentFilename" class="current-filename"></span>
        </h1>
      </div>

      <!-- Upload Area -->
      <div id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">Drag & Drop your Excel file here</div>
          <div class="upload-hint">or click to browse</div>
          <input type="file" id="fileInput" accept=".xlsx,.xls" />
        </div>
      </div>

      <!-- Loader -->
      <div class="loader-section" id="loader">
        <div class="loader"></div>
        <div class="loader-title">Processing your file...</div>
        <div class="upload-hint">This may take a few seconds</div>
      </div>

      <!-- Results -->
      <div class="results" id="results">

        <!-- Metrics -->
        <div class="metrics" id="metrics"></div>

        <!-- Alert -->
        <div id="alertContainer"></div>

        <!-- Download Section -->
        <div class="download-section" id="downloadSection">
          <h2 class="section-title">Violation Emails</h2>
          <div class="sellers-table" id="sellersTable"></div>
        </div>
      </div>
    </div>

    <script>
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const uploadSection = document.getElementById("uploadSection");
      const loader = document.getElementById("loader");
      const results = document.getElementById("results");

      // Click to upload - only when upload section is visible
      uploadArea.addEventListener("click", (e) => {
        if (uploadSection.style.display !== "none") {
          fileInput.click();
        }
      });

      // Drag and drop handlers - only when upload section is visible
      uploadArea.addEventListener("dragover", (e) => {
        if (uploadSection.style.display !== "none") {
          e.preventDefault();
          uploadArea.classList.add("dragging");
        }
      });

      uploadArea.addEventListener("dragleave", () => {
        if (uploadSection.style.display !== "none") {
          uploadArea.classList.remove("dragging");
        }
      });

      uploadArea.addEventListener("drop", (e) => {
        if (uploadSection.style.display !== "none") {
          e.preventDefault();
          uploadArea.classList.remove("dragging");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFile(files[0]);
          }
        }
      });

      // File input change
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      async function handleFile(file) {
        // Validate file type
        if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
          showAlert("Please upload an Excel file (.xlsx or .xls)", "error");
          // clear filename if invalid
          const filenameSpan = document.getElementById("currentFilename");
          if (filenameSpan) filenameSpan.textContent = "";
          return;
        }

        // Show loader
        uploadSection.style.display = "none";
        loader.classList.add("active");

        // Create form data
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          // Check if response is ok
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Debug: log the response

          // Hide loader
          loader.classList.remove("active");

          if (data.error) {
            console.error("Server returned error:", data.error);
            showAlert(data.error, "error");
            uploadSection.style.display = "block";
            // clear filename on error
            const filenameSpan = document.getElementById("currentFilename");
            if (filenameSpan) filenameSpan.textContent = "";
            return;
          }

          // Show results
          // If server returns the uploaded filename, ensure the title shows it (sanity)
          if (data.uploaded_filename) {
            const filenameSpan2 = document.getElementById("currentFilename");
            if (filenameSpan2)
              filenameSpan2.textContent = data.uploaded_filename;
          }

          displayResults(data);
        } catch (error) {
          console.error("Upload error:", error);
          loader.classList.remove("active");
          showAlert(`Error processing file: ${error.message}. Please try again.`, "error");
          uploadSection.style.display = "block";
          const filenameSpan = document.getElementById("currentFilename");
          if (filenameSpan) filenameSpan.textContent = "";
        }
      }

      function displayResults(data) {
        // Save data globally for refresh purposes
        window.lastAnalysisResult = data;
        
        // Hide upload section when displaying results
        uploadSection.style.display = "none";
        
        results.classList.add("active");

        // Check if tracking is enabled and we have the new format
        if (data.tracking_enabled && data.sellers) {
          // Display NEW tracker metrics
          const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-value">${data.total_active_violations || 0}</div>
                    <div class="metric-label">Active Violations</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.unique_violators || 0}</div>
                    <div class="metric-label">Violators</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.day_1_count || 0}</div>
                    <div class="metric-label">Day 1 (New)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.day_2_count || 0}</div>
                    <div class="metric-label">Day 2 (24h)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.day_3_count || 0}</div>
                    <div class="metric-label">Day 3+ (DNS)</div>
                </div>
            `;
          document.getElementById("metrics").innerHTML = metricsHTML;
        } else {
          // OLD metrics format (fallback)
          const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-value">${data.total_rows || 0}</div>
                    <div class="metric-label">Total Rows</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.total_violations || 0}</div>
                    <div class="metric-label">Total Violations</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.num_sellers || data.sellers?.length || 0}</div>
                    <div class="metric-label">Sellers with Violations</div>
                </div>
            `;
          document.getElementById("metrics").innerHTML = metricsHTML;
        }

        if (data.no_violations) {
          if (data.excluded_only) {
            showAlert("‚ÑπÔ∏è " + data.message, "info");
          } else {
            showAlert("üéâ " + data.message, "success");
          }
          document.getElementById("downloadSection").style.display = "none";
        } else {
          // Show processing message
          if (data.message) {
            showAlert("‚úÖ " + data.message, "success");
          }

          // Check if we have sellers data
          if (!data.sellers || data.sellers.length === 0) {
            showAlert("‚ö†Ô∏è No active violations found in tracking system", "info");
            document.getElementById("downloadSection").style.display = "none";
            return;
          }

          // Display sellers with products grouped
          const sellersGrid = data.sellers
            .map((seller) => {
              const contact = seller.contact || {};
              const hasEmail = contact.email && contact.email !== 'N/A';
              const hasPhone = contact.phone && contact.phone !== 'N/A';
              const isNewViolator = !hasEmail && !hasPhone;
              const contactRowClass = isNewViolator ? 'contact-row new-violator' : 'contact-row';

              // Build contact section
              const emails = hasEmail ? contact.email.split('/').map(e => e.trim()) : [];
              const emailsHTML = emails.length > 0
                ? emails.map(email => `
                    <div class="contact-item">
                      <span class="contact-label">Email:</span>
                      <span class="contact-value">${email}</span>
                      <button class="copy-contact-btn" onclick="copyContact('${email}', this)">Copy</button>
                    </div>
                  `).join('')
                : `<div class="contact-item"><span class="contact-label">Email:</span><span class="contact-value not-available">Not registered</span></div>`;

              const phoneHTML = hasPhone
                ? `<div class="contact-item"><span class="contact-label">Phone:</span><span class="contact-value">${contact.phone}</span><button class="copy-contact-btn" onclick="copyContact('${contact.phone}', this)">Copy</button></div>`
                : `<div class="contact-item"><span class="contact-label">Phone:</span><span class="contact-value not-available">Not registered</span></div>`;

              const newViolatorBadge = isNewViolator
                ? '<div class="badge badge--new-violator">‚ö† NEW VIOLATOR - Research Required</div>'
                : '';

              // Group products by day
              const day1 = seller.products.filter(p => p.day_status === 'DAY_1');
              const day2 = seller.products.filter(p => p.day_status === 'DAY_2');
              const day3 = seller.products.filter(p => p.day_status === 'DAY_3');

              // Determine border color class based on process status
              let severityClass = '';
              
              // Check if any DAY 3+ product is in DNS (RED)
              const hasInDNS = day3.some(p => p.in_dns);
              // Check if any DAY 3+ product is pending approval (ORANGE)
              const hasPending = day3.some(p => p.pending_approval);
              
              if (hasInDNS) {
                severityClass = 'has-dns'; // Red - Added to DNS
              } else if (hasPending) {
                severityClass = 'has-day3'; // Orange - Sent to Daniel (pending)
              } else if (day3.length > 0) {
                severityClass = 'has-day3'; // Orange - Ready to escalate
              } else if (day2.length > 0) {
                severityClass = 'has-day2'; // Yellow - Second notice
              } else {
                severityClass = ''; // Blue - Default for DAY 1 (new violations)
              }

              // Helper function to create product HTML
              const createProductHTML = (products) => products.map(p => `
                <div class="product-item">
                  <div class="product-item__sku">SKU: ${p.sku}</div>
                  <div class="product-item__description">${p.description}</div>
                  <div class="product-item__pricing">
                    <span class="price--current">Price: $${p.current_price.toFixed(2)}</span> | 
                    <span class="price--target">Should be: $${p.map_price.toFixed(2)}</span>
                  </div>
                </div>
              `).join('');

              // Helper function to create violation section
              const createViolationSection = ({ products, dayClass, title, dayIndex, sellerName, emailSent, emailDate, revertFunction }) => `
                <div class="violation-section ${dayClass}">
                  <div class="section-header">
                    <div class="section-header__content">
                      <h3 class="section-header__title">${title} (${products.length} items)</h3>
                      <div class="section-header__actions">
                        <button class="btn btn--info" onclick="copySubjectByDay('${sellerName}', ${dayIndex}, this)">Copy Subject</button>
                        <button class="btn btn--secondary" onclick="previewEmailByDay('${sellerName}', ${dayIndex})">Preview Email</button>
                        <button class="btn btn--primary" onclick="copyEmailByDay('${sellerName}', ${dayIndex}, this)">Copy Email</button>
                      </div>
                    </div>
                  </div>
                  <div class="products-container">
                    ${createProductHTML(products)}
                  </div>
                  <div class="email-section">
                    <div class="email-tracking">
                      <label class="email-tracking__label">
                        <input type="checkbox" 
                               class="email-tracking__checkbox"
                               ${emailSent > 0 ? 'checked disabled' : ''} 
                               onchange="${dayIndex === 0 ? 'markFirstEmailSent' : 'markSecondEmailSent'}('${sellerName}', this)">
                        <strong>‚úì Mark as sent</strong>
                      </label>
                      ${emailSent > 0 ? 
                        `<button class="btn btn--danger btn--small" onclick="${revertFunction}('${sellerName}', this)">Undo</button>` : 
                        ''
                      }
                      <span class="email-status-text">
                        ${emailSent > 0 ? `‚úÖ Sent on ${emailDate || 'Unknown date'}` : 'üìß Not sent yet'}
                      </span>
                    </div>
                  </div>
                </div>
              `;

              let groupedHTML = '';

              // DAY 1 GROUP
              if (day1.length > 0) {
                groupedHTML += createViolationSection({
                  products: day1,
                  dayClass: 'violation-section--day1',
                  title: 'üü¢ NEW VIOLATIONS - Day 1',
                  dayIndex: 0,
                  sellerName: seller.name,
                  emailSent: seller.first_emails_sent || 0,
                  emailDate: seller.first_email_date,
                  revertFunction: 'revertFirstEmail'
                });
              }

              // DAY 2 GROUP
              if (day2.length > 0) {
                groupedHTML += createViolationSection({
                  products: day2,
                  dayClass: 'violation-section--day2',
                  title: 'üü† SECOND NOTICE - Day 2',
                  dayIndex: 1,
                  sellerName: seller.name,
                  emailSent: seller.second_emails_sent || 0,
                  emailDate: seller.second_email_date,
                  revertFunction: 'revertSecondEmail'
                });
              }

              // DAY 3 GROUP
              if (day3.length > 0) {
                const day3Products = day3.map(p => `
                  <div class="product-item">
                    <div class="product-item__sku">SKU: ${p.sku}</div>
                    <div class="product-item__description">${p.description}</div>
                    <div class="product-item__pricing">
                      <span class="price--current">Price: $${p.current_price.toFixed(2)}</span> | 
                      <span class="price--target">Should be: $${p.map_price.toFixed(2)}</span>
                    </div>
                  </div>
                `).join('');

                // Check if ANY product has pending_approval or in_dns
                const hasPending = day3.some(p => p.pending_approval);
                const hasInDNS = day3.some(p => p.in_dns);

                // Status badges now use CSS classes for consistency
                let statusBadge = '';
                
                if (hasInDNS) {
                  statusBadge = '<span class="status-badge status-badge--in-dns">üö´ BLOCKED IN DNS</span>';
                } else if (hasPending) {
                  statusBadge = '<span class="status-badge status-badge--pending">‚è≥ Pending Approval</span>';
                } else {
                  statusBadge = '<span class="status-badge status-badge--sent-to-boss">‚ö† READY FOR ESCALATION</span>';
                }

                // Determine title, text and CSS class based on state
                let headerTitle = 'üî¥ CRITICAL - Day 3+';
                let statusText = 'Needs action';
                let stateClass = ''; // Clase adicional para el borde
                
                if (hasInDNS) {
                  headerTitle = 'üî¥ BLOCKED - Day 3+';
                  statusText = 'Currently blocked';
                  stateClass = 'blocked'; // Rojo
                } else if (hasPending) {
                  headerTitle = 'üü† PENDING - Day 3+';
                  statusText = 'Sent to Daniel - Waiting for approval decision';
                  stateClass = 'pending'; // Morado
                } else {
                  headerTitle = 'üî¥ CRITICAL - Day 3+';
                  statusText = 'Critical violations detected - Ready for escalation';
                  stateClass = ''; // Naranja (por defecto)
                }

                groupedHTML += `
                  <div class="violation-day-section day-3 ${stateClass}">
                    
                    <!-- Header Section -->
                    <div class="day-header">
                      <div class="day-header-content">
                        <div class="day-header-title">
                          <h3 class="section-header__title">üö® ${headerTitle} (${day3.length} items)</h3>
                          ${statusBadge}
                        </div>
                        <div class="day-header-actions">
                          ${hasInDNS ? 
                            `<button class="btn btn--secondary" onclick="removeDNS('${seller.name}', this)" title="Remove applied DNS restriction">Remove from DNS</button>` :
                            hasPending ?
                            `<button class="btn btn--success" onclick="approveDNS('${seller.name}', this)" title="Approve recommended DNS block">‚úì Approve</button>
                             <button class="btn btn--danger" onclick="rejectDNS('${seller.name}', this)" title="Reject block recommendation">‚úó Reject</button>` :
                            `<button class="btn btn--primary copy-btn send-to-boss-btn" data-seller="${seller.name}" data-email="${contact.email}" data-phone="${contact.phone}" data-products='${JSON.stringify(day3)}' title="Escalate to boss for decision">Send to Boss</button>`
                          }
                        </div>
                      </div>
                      <div class="day-header-status">
                        Status: ${statusText}
                      </div>
                    </div>

                    <!-- Products List -->
                    <div class="products-container">
                      ${day3Products}
                    </div>
                  </div>
                `;
              }

              return `
                <div class="seller-section ${severityClass}" data-seller-name="${seller.name}">
                  <div class="seller-header">
                    <h3 class="seller-name">${seller.name}${seller.in_dns ? ' <span style="color: #EF4444; font-weight: bold;">üö´ DNS</span>' : ''}</h3>
                    ${newViolatorBadge}
                  </div>
                  <div class="${contactRowClass}">
                    ${emailsHTML}
                    ${phoneHTML}
                  </div>
                  ${groupedHTML}
                </div>
              `;
            })
            .join("");

          document.getElementById("sellersTable").innerHTML = `
            <div class="sellers-grid">
              ${sellersGrid}
            </div>
          `;

          // Add event listeners for "Send to Boss" buttons
          document.querySelectorAll('.send-to-boss-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const sellerName = this.dataset.seller;
              const email = this.dataset.email;
              const phone = this.dataset.phone;
              const products = JSON.parse(this.dataset.products);
              sendToBoss(sellerName, products, email, phone, this);
            });
          });
        }
      }

      async function loadSubject(filename) {
        try {
          const response = await fetch(`/get-email-content/${filename}`);
          const data = await response.json();
          
          if (!data.error && data.subject) {
            const subjectElement = document.getElementById(`subject-${filename.replace('.html', '')}`);
            if (subjectElement) {
              subjectElement.textContent = data.subject;
            }
          }
        } catch (error) {
          console.error('Error loading subject:', error);
        }
      }

      async function copySubject(filename, button) {
        try {
          const response = await fetch(`/get-email-content/${filename}`);
          const data = await response.json();

          if (data.error) {
            showAlert("Error loading subject", "error");
            return;
          }

          // Copy subject to clipboard
          await navigator.clipboard.writeText(data.subject || '');

          // Visual feedback
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì";
          button.classList.add("copied");

          // Reset button after 2 seconds
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove("copied");
          }, 2000);

        } catch (error) {
          showAlert("Error copying subject to clipboard", "error");
        }
      }

      async function copyEmail(filename, button) {
        try {
          // Get email content from server
          const response = await fetch(`/get-email-content/${filename}`);
          const data = await response.json();

          if (data.error) {
            showAlert("Error loading email content", "error");
            return;
          }

          // Convert HTML -> plain text while preserving line breaks
          function htmlToText(html) {
            if (!html) return "";

            // Replace <br> with newlines
            let txt = html.replace(/<br\s*\/?>/gi, "\n");

            // Replace closing block tags with newlines to preserve paragraphs/lists
            txt = txt.replace(/<\/(p|div|li|tr|h[1-6]|blockquote)>/gi, "\n");

            // Replace list item starts with a bullet and space
            txt = txt.replace(/<li[^>]*>/gi, "\u2022 ");

            // Remove remaining tags
            txt = txt.replace(/<[^>]+>/g, "");

            // Decode HTML entities using a temporary textarea
            const ta = document.createElement("textarea");
            ta.innerHTML = txt;
            txt = ta.value;

            // Normalize multiple blank lines and trim
            txt = txt.replace(/\r\n|\r/g, "\n");
            txt = txt.replace(/\n{3,}/g, "\n\n");
            return txt.trim();
          }

          // Prepare robust HTML and plain-text for clipboard so Outlook pastes with line breaks
          function escapeHTML(str) {
            return String(str || "")
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;");
          }

          function plainToHtml(text) {
            if (!text) return "";
            // Normalize newlines
            const t = String(text).replace(/\r\n|\r/g, "\n");
            // Split into paragraphs on double newlines
            const paras = t.split(/\n{2,}/).map((p) => {
              // Within a paragraph convert single newlines to <br>
              const inner = escapeHTML(p).replace(/\n/g, "<br>");
              return `<p>${inner}</p>`;
            });
            return `<div class="email-clipboard-content">${paras.join(
              ""
            )}</div>`;
          }

          // Determine if server returned HTML or plain text
          let htmlForClipboard = data.body || "";
          const looksLikeHTML = /<[^>]+>/.test(String(htmlForClipboard));

          if (!looksLikeHTML) {
            // Convert plain text to safe HTML with paragraphs/BRs
            htmlForClipboard = plainToHtml(htmlForClipboard);
          } else {
            // Ensure the HTML is wrapped to keep styling consistent
            htmlForClipboard = `<div class="email-clipboard-content">${data.body}</div>`;
          }

          // Create a plain-text version with CRLF line endings for Windows/Outlook
          let plain = htmlToText(data.body);
          if (!plain) plain = (data.body || "").toString();
          // Normalize to CRLF which Outlook expects
          plain = plain.replace(/\r\n|\r|\n/g, "\r\n");

          const htmlBlob = new Blob([htmlForClipboard], { type: "text/html" });
          const textBlob = new Blob([plain], { type: "text/plain" });

          const clipboardItem = new ClipboardItem({
            "text/html": htmlBlob,
            "text/plain": textBlob,
          });

          await navigator.clipboard.write([clipboardItem]);

          // Mark the entire row as copied
          const row = button.closest(".table-row");
          row.classList.add("copied");

          // Mark the entire seller section as email-copied
          const section = button.closest(".seller-section");
          if (section) {
            section.classList.add("email-copied");
          }

          // Visual feedback on button
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì";
          button.classList.add("copied");

          // Reset button after 2 seconds but keep card marked
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove("copied");
          }, 2000);

          // Email copied successfully (no alert to avoid page jump)
        } catch (error) {
          console.error("Copy error:", error);
          showAlert(
            "Error copying to clipboard. Please try downloading instead.",
            "error"
          );
        }
      }

      async function copyContact(contactValue, button) {
        try {
          await navigator.clipboard.writeText(contactValue);
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì";
          button.classList.add("copied");
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove("copied");
          }, 2000);
        } catch (error) {
          console.error("Copy error:", error);
          showAlert("Error copying to clipboard", "error");
        }
      }

      async function refreshResults() {
        try {
          const response = await fetch('/api/get-current-violations');
          const data = await response.json();

          if (data.success) {
            displayResults(data);
          } else {
            showAlert("Error refreshing results", "error");
          }
        } catch (error) {
          console.error("Error refreshing:", error);
          showAlert("Error refreshing results", "error");
        }
      }

      async function markAllDay1(sellerName, checkbox) {
        try {
          const response = await fetch('/api/mark-all-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName, day: 0 })
          });

          if (response.ok) {
            showAlert("DAY 1 emails marked as sent", "success");
            checkbox.parentElement.style.opacity = '0.6';
            checkbox.disabled = true;
          } else {
            showAlert("Error marking emails", "error");
            checkbox.checked = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error marking emails", "error");
          checkbox.checked = false;
        }
      }

      async function markAllDay2(sellerName, checkbox) {
        try {
          const response = await fetch('/api/mark-all-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName, day: 1 })
          });

          if (response.ok) {
            showAlert("DAY 2 emails marked as sent", "success");
            checkbox.parentElement.style.opacity = '0.6';
            checkbox.disabled = true;
          } else {
            showAlert("Error marking emails", "error");
            checkbox.checked = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error marking emails", "error");
          checkbox.checked = false;
        }
      }

      async function markAllDNS(sellerName, checkbox) {
        try {
          const response = await fetch('/api/mark-all-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName, day: 2 })
          });

          if (response.ok) {
            showAlert("Marked as added to DNS", "success");
            checkbox.parentElement.style.opacity = '0.6';
            checkbox.disabled = true;
          } else {
            showAlert("Error marking DNS", "error");
            checkbox.checked = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error marking DNS", "error");
          checkbox.checked = false;
        }
      }

      async function sendToBoss(sellerName, day3Products, email, phone, button) {
        try {
          // Format: Simple text for boss to review
          let report = `${sellerName}\n`;
          report += `${email}\n`;
          report += `${phone}\n\n`;

          // Get the first product's days_active (they should all be the same for DAY 3+)
          const daysActive = day3Products[0]?.days_active || 3;
          report += `DAY 3+ Violations (${daysActive} days active):\n`;

          day3Products.forEach(p => {
            report += `- ${p.description} (SKU: ${p.sku}) - $${p.current_price.toFixed(2)} (MAP: $${p.map_price.toFixed(2)})\n`;
          });

          await navigator.clipboard.writeText(report);

          // Mark as pending approval in DB
          const response = await fetch('/api/send-to-boss', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName })
          });

          if (response.ok) {
            showAlert("Report copied! Status: Pending Approval", "success");
            // Refresh results without re-uploading
            setTimeout(() => {
              refreshResults();
            }, 1500);
          } else {
            showAlert("Copied but failed to update status", "warning");
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error sending to boss", "error");
        }
      }

      async function approveDNS(sellerName, button) {
        try {
          setButtonLoading(button, 'Approving...');

          const response = await fetch('/api/approve-dns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName })
          });

          if (response.ok) {
            setButtonSuccess(button, '‚úÖ Approved');
            showAlert("Added to DNS successfully", "success");
            // Refresh results without re-uploading
            setTimeout(() => {
              refreshResults();
            }, 1500);
          } else {
            setButtonError(button);
            showAlert("Error approving DNS", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          setButtonError(button);
          showAlert("Error approving DNS", "error");
        }
      }

      async function rejectDNS(sellerName, button) {
        try {
          setButtonLoading(button, 'Rejecting...');

          const response = await fetch('/api/reject-dns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName })
          });

          if (response.ok) {
            setButtonSuccess(button, '‚ùå Rejected');
            showAlert("Rejected - removed from pending", "success");
            // Refresh results without re-uploading
            setTimeout(() => {
              refreshResults();
            }, 1500);
          } else {
            setButtonError(button);
            showAlert("Error rejecting DNS", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          setButtonError(button);
          showAlert("Error rejecting DNS", "error");
        }
      }

      async function removeDNS(sellerName, button) {
        try {
          button.disabled = true;
          button.textContent = 'Removing...';

          const response = await fetch('/api/reject-dns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName })
          });

          if (response.ok) {
            showAlert("Removed from DNS", "success");
            // Refresh results without re-uploading
            setTimeout(() => {
              refreshResults();
            }, 1500);
          } else {
            showAlert("Error removing from DNS", "error");
            button.disabled = false;
            button.textContent = 'Remove from DNS';
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error removing from DNS", "error");
          button.disabled = false;
          button.textContent = 'Remove from DNS';
        }
      }

      async function markEmailSent(violationId, emailType, checkbox) {
        try {
          const response = await fetch('/api/mark-email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({violation_id: violationId, email_type: emailType})
          });

          if (response.ok) {
            checkbox.parentElement.classList.add('checked');
          } else {
            showAlert("Error updating checkbox", "error");
            checkbox.checked = !checkbox.checked;
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error updating checkbox", "error");
          checkbox.checked = !checkbox.checked;
        }
      }

      async function markDNS(violationId, checkbox) {
        try {
          const response = await fetch('/api/mark-dns', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({violation_id: violationId})
          });

          if (response.ok) {
            checkbox.parentElement.classList.add('checked');
          } else {
            showAlert("Error updating checkbox", "error");
            checkbox.checked = !checkbox.checked;
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error updating checkbox", "error");
          checkbox.checked = !checkbox.checked;
        }
      }

      // Email Tracking Functions - Simplified
      async function markFirstEmailSent(sellerName, checkbox) {
        try {
          const response = await fetch('/api/mark-all-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName, day: 0 })
          });

          const result = await response.json();
          
          if (result.success) {
            checkbox.disabled = true;
            showAlert("Day 1 email marked as sent", "success");
            
            // Update only this seller's data to preserve progress
            setTimeout(() => {
              updateSellerData(sellerName);
            }, 300);
          } else {
            checkbox.checked = false; // Uncheck if failed
            showAlert("Error marking Day 1 email", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          checkbox.checked = false; // Uncheck if failed
          showAlert("Error marking Day 1 email", "error");
        }
      }

      async function markSecondEmailSent(sellerName, checkbox) {
        try {
          const response = await fetch('/api/mark-all-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seller_name: sellerName, day: 1 })
          });

          if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
              checkbox.disabled = true;
              showAlert("Day 2 email marked as sent", "success");
              
              // Update only this seller's data to preserve progress
              setTimeout(() => {
                updateSellerData(sellerName);
              }, 300);
            } else {
              checkbox.checked = false; // Uncheck if failed
              showAlert(`Error marking Day 2 email: ${result.error || 'Unknown error'}`, "error");
              console.error("Backend error:", result);
            }
          } else {
            checkbox.checked = false;
            const errorText = await response.text();
            showAlert(`Error marking Day 2 email (HTTP ${response.status}): ${errorText}`, "error");
            console.error("HTTP error:", response.status, errorText);
          }
        } catch (error) {
          console.error("Network/Parse error:", error);
          checkbox.checked = false; // Uncheck if failed
          showAlert(`Error marking Day 2 email: ${error.message}`, "error");
        }
      }

      // Revert Email Functions
      async function revertFirstEmail(sellerName, button) {
        if (!confirm(`Are you sure you want to revert the first email state for ${sellerName}?`)) {
          return;
        }
        
        try {
          const response = await fetch(`/api/revert-first-email/${encodeURIComponent(sellerName)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert(result.message, "success");
            
            // Refresh the display to update counts
            setTimeout(() => {
              if (typeof displayResults === 'function') {
                displayResults(window.lastAnalysisResult || {});
              }
            }, 500);
          } else {
            showAlert(result.error || "Error reverting first email", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error reverting first email", "error");
        }
      }

      async function revertSecondEmail(sellerName, button) {
        if (!confirm(`Are you sure you want to revert the second email state for ${sellerName}?`)) {
          return;
        }
        
        try {
          const response = await fetch(`/api/revert-second-email/${encodeURIComponent(sellerName)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert(result.message, "success");
            
            // Refresh the display to update counts
            setTimeout(() => {
              if (typeof displayResults === 'function') {
                displayResults(window.lastAnalysisResult || {});
              }
            }, 500);
          } else {
            showAlert(result.error || "Error reverting second email", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error reverting second email", "error");
        }
      }

      async function markDNSAdded(sellerName, button) {
        try {
          const response = await fetch(`/api/mark-dns-added/${encodeURIComponent(sellerName)}`, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}
          });
          
          const result = await response.json();
          
          if (result.success) {
            button.classList.add('sent');
            button.disabled = true;
            button.innerHTML = 'Added to DNS';
            showAlert(result.message, "success");
            
            // Refresh the display to update counts
            setTimeout(() => {
              if (typeof displayResults === 'function') {
                displayResults(window.lastAnalysisResult || {});
              }
            }, 500);
          } else {
            showAlert(result.error || "Error adding to DNS", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error adding to DNS", "error");
        }
      }

      async function previewEmailByDay(sellerName, day) {
        try {
          const response = await fetch(`/api/get-email-by-day/${encodeURIComponent(sellerName)}/${day}`);
          const data = await response.json();

          if (data.error) {
            showAlert("Error loading email", "error");
            return;
          }

          // Show email preview in modal
          showEmailPreview(sellerName, day, data.subject, data.body);
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error loading preview", "error");
        }
      }

      async function copyEmailByDay(sellerName, day, button) {
        try {
          const response = await fetch(`/api/get-email-by-day/${encodeURIComponent(sellerName)}/${day}`);
          const data = await response.json();

          if (data.error) {
            showAlert("Error generating email", "error");
            return;
          }

          // Copy to clipboard in HTML + plain text format (for Outlook)
          const htmlBlob = new Blob([data.body], { type: 'text/html' });
          const textBlob = new Blob([data.body.replace(/<[^>]*>/g, '')], { type: 'text/plain' });

          const clipboardItem = new ClipboardItem({
            'text/html': htmlBlob,
            'text/plain': textBlob
          });

          await navigator.clipboard.write([clipboardItem]);

          // Visual feedback
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì Copied!";
          button.style.background = "rgba(96, 125, 139, 0.15)";
          button.style.color = "#37474f";

          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = "";
            button.style.color = "";
          }, 2000);

          showAlert(`Email copied! Subject: ${data.subject}`, "success");
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error copying email", "error");
        }
      }

      async function copySubjectByDay(sellerName, day, button) {
        try {
          const response = await fetch(`/api/get-email-by-day/${encodeURIComponent(sellerName)}/${day}`);
          const data = await response.json();

          if (data.error) {
            showAlert("Error generating subject", "error");
            return;
          }

          // Copy subject as plain text to clipboard
          await navigator.clipboard.writeText(data.subject);

          // Visual feedback
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì Copied!";
          button.style.background = "rgba(96, 125, 139, 0.15)";
          button.style.color = "#37474f";

          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = "";
            button.style.color = "";
          }, 2000);

          showAlert("Subject copied to clipboard!", "success");
        } catch (error) {
          console.error("Error:", error);
          showAlert("Error copying subject", "error");
        }
      }

      function downloadFile(filename) {
        window.location.href = `/download/${filename}`;
      }

      // Modal functionality removed

      function displayVerificationStatsNew(stats) {
        const savings = stats.avg_map_price - stats.avg_current_price;
        const savingsPercent = (savings / stats.avg_map_price * 100).toFixed(1);
        
        // Calculate confidence score based on data quality factors
        let confidenceScore = 85;
        if (stats.avg_map_price > 100 && stats.avg_map_price < 10000) confidenceScore += 5;
        if (stats.max_violation < stats.avg_map_price * 0.8) confidenceScore += 5;
        if (stats.min_violation > 10) confidenceScore += 3;
        if (savingsPercent > 5 && savingsPercent < 50) confidenceScore += 2;
        confidenceScore = Math.min(97, confidenceScore);
        
        const verificationHTML = `
          <div class="verification-panel">
            <div class="confidence-header">
              <h3>Data Validation Report</h3>
              <div class="confidence-score">
                <span class="score-label">Confidence Level:</span>
                <span class="score-value">${confidenceScore}%</span>
              </div>
            </div>
            
            <div class="analysis-factors">
              <h4>Validation Factors Analyzed:</h4>
              <ul class="factor-list">
                <li>Data structure integrity and required columns presence</li>
                <li>Numeric price validation (MAP: $${stats.avg_map_price.toFixed(0)}, Current: $${stats.avg_current_price.toFixed(0)})</li>
                <li>Price difference logic verification (${savingsPercent}% average under-pricing)</li>
                <li>Violation range analysis ($${stats.min_violation.toFixed(0)} - $${stats.max_violation.toFixed(0)})</li>
                <li>Seller data completeness and format consistency</li>
                <li>Business rule compliance (all violations below MAP threshold)</li>
                ${stats.excluded_sellers_count > 0 ? 
                  `<li class="excluded-sellers-warning">Seller filtering: ${stats.excluded_sellers_count} violations from excluded sellers not processed</li>` : ''}
              </ul>
            </div>
            
            ${stats.excluded_sellers_count > 0 ? `
            <div class="excluded-sellers-info">
              <h4 class="excluded-sellers-title">
                <i class="fas fa-filter"></i> Excluded Sellers (${stats.excluded_sellers_list.length})
              </h4>
              <div class="excluded-sellers-content">
                <strong>${stats.excluded_sellers_count} violations filtered out</strong> from: 
                <span class="excluded-sellers-list">
                  ${stats.excluded_sellers_list.join(', ')}
                </span>
              </div>
              <div class="excluded-sellers-note">
                These sellers are configured as non-processable in the system settings.
              </div>
            </div>
            ` : ''}
            
            <div class="recommendation">
              ${confidenceScore >= 90 ? 
                '<strong>RECOMMENDATION:</strong> Data quality is high. Proceed with email generation.' :
                '<strong>RECOMMENDATION:</strong> Review data before proceeding. Consider manual verification.'}
            </div>
          </div>
        `;
        
        const sellersTable = document.getElementById("sellersTable");
        sellersTable.insertAdjacentHTML('beforebegin', verificationHTML);
      }

      function displayVerificationStats(stats) {
        const savings = stats.avg_map_price - stats.avg_current_price;
        const savingsPercent = (savings / stats.avg_map_price * 100).toFixed(1);
        
        // Calculate confidence score based on data quality factors
        let confidenceScore = 85; // Base score
        if (stats.avg_map_price > 100 && stats.avg_map_price < 10000) confidenceScore += 5;
        if (stats.max_violation < stats.avg_map_price * 0.8) confidenceScore += 5;
        if (stats.min_violation > 10) confidenceScore += 3;
        if (savingsPercent > 5 && savingsPercent < 50) confidenceScore += 2;
        confidenceScore = Math.min(97, confidenceScore);
        
        const verificationHTML = `
          <div class="verification-panel">
            <h3>ÔøΩ Quick Validation Checklist</h3>
            <div class="validation-checks">
              <div class="check-item">
                <span class="check-icon">‚úÖ</span>
                <div class="check-content">
                  <strong>All sellers are selling BELOW MAP price</strong>
                  <small>Current prices are ${savingsPercent}% lower than MAP on average</small>
                </div>
              </div>
              <div class="check-item">
                <span class="check-icon">‚ö†Ô∏è</span>
                <div class="check-content">
                  <strong>Biggest violation: $${stats.max_violation.toFixed(2)} under MAP</strong>
                  <small>This seller is significantly undercutting - priority email</small>
                </div>
              </div>
              <div class="check-item">
                <span class="check-icon">üìä</span>
                <div class="check-content">
                  <strong>Smallest violation: $${stats.min_violation.toFixed(2)} under MAP</strong>
                  <small>Minor violation - still needs attention</small>
                </div>
              </div>
            </div>
            <div class="verification-actions">
              <button onclick="showRawDataPreview()" class="verify-data-btn">
                üî¢ Show Raw Data Sample
              </button>
              <span class="confidence-indicator">
                üìã Data looks valid - ${savingsPercent}% average discount detected
              </span>
            </div>
          </div>
        `;
        
        // Insert before sellers table
        const sellersTable = document.getElementById("sellersTable");
        sellersTable.insertAdjacentHTML('beforebegin', verificationHTML);
      }

      async function showSellerDetails(filename) {
        try {
          const response = await fetch(`/get-email-content/${filename}`);
          const data = await response.json();
          
          if (data.error) {
            showAlert("Error loading seller details", "error");
            return;
          }
          
          // Get seller name from the filename
          const sellerName = filename.replace('email_', '').replace('.html', '').replace(/_/g, ' ');
          
          // Create modal with full email content
          const modalHTML = `
            <div class="modal-overlay" onclick="closeModal()">
              <div class="modal-content email-verification-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                  <h3>ÔøΩ Email Verification: ${sellerName}</h3>
                  <button onclick="closeModal()" class="close-btn">√ó</button>
                </div>
                
                <div class="modal-body">
                  <div class="email-section">
                    <h4>üìß Subject Line:</h4>
                    <div class="subject-display">${data.subject}</div>
                  </div>
                  
                  <div class="email-section">
                    <h4>üìù Complete Email Body:</h4>
                    <div class="email-body-display">${data.body}</div>
                  </div>
                  
                  <div class="email-section">
                    <h4>üìã Plain Text Version:</h4>
                    <div class="plain-text-display">${data.body.replace(/<[^>]*>/g, '').replace(/\n{3,}/g, '\n\n')}</div>
                  </div>
                </div>
                
                <div class="modal-footer">
                  <div class="verification-checklist">
                    <h4>‚úÖ Verify This:</h4>
                    <label><input type="checkbox"> Seller name is correct</label>
                    <label><input type="checkbox"> Product count matches expectation</label>
                    <label><input type="checkbox"> Prices look reasonable</label>
                    <label><input type="checkbox"> All product details present</label>
                  </div>
                  <div class="modal-actions">
                    <button onclick="copyFullEmail('${filename}')" class="copy-full-btn">üìã Copy This Email</button>
                    <button onclick="closeModal()" class="close-modal-btn">Close</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
        } catch (error) {
          showAlert("Error loading seller details", "error");
        }
      }

      async function copyFullEmail(filename) {
        try {
          const response = await fetch(`/get-email-content/${filename}`);
          const data = await response.json();
          
          if (data.error) {
            showAlert("Error loading email", "error");
            return;
          }

          // Copy the plain text version
          const plainText = data.body.replace(/<[^>]*>/g, '').replace(/\n{3,}/g, '\n\n');
          await navigator.clipboard.writeText(plainText);
          
          // Update button feedback
          const button = document.querySelector('.copy-full-btn');
          if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ Copied!';
            setTimeout(() => {
              button.innerHTML = originalText;
            }, 2000);
          }
        } catch (error) {
          showAlert("Error copying email", "error");
        }
      }

      function showEmailPreview(sellerName, day, subject, body) {
        const dayLabels = {
          0: 'üü¢ Day 1 - First Notice',
          1: 'üü† Day 2 - Second Notice', 
          2: 'üî¥ Day 3+ - Final Notice'
        };
        
        const modalHTML = `
          <div class="modal-overlay" onclick="closeModal()">
            <div class="modal-content email-preview-modal" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h4 class="modal-title">
                  Email Preview - ${sellerName}
                </h4>
              </div>
              
              <button onclick="closeModal()" class="modal-close-btn" onmouseover="this.style.background='#3A5F8A'; this.style.color='#E6EEF9'" onmouseout="this.style.background='none'; this.style.color='#9CB3D1'">√ó</button>
              
              <div class="modal-body email-preview-body">
                ${body}
              </div>

              ">

                    ÔøΩ 

                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      function closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
          modal.remove();
        }
      }

      async function showRawDataPreview() {
        // Get first few sellers' data to show sample
        const sellers = document.querySelectorAll('.seller-section');
        let sampleData = [];
        
        for (let i = 0; i < Math.min(3, sellers.length); i++) {
          const filename = sellers[i].getAttribute('data-filename');
          try {
            const response = await fetch(`/get-email-content/${filename}`);
            const data = await response.json();
            if (!data.error) {
              // Extract key info from email body for verification
              const bodyText = data.body.replace(/<[^>]*>/g, ''); // Strip HTML
              sampleData.push({
                seller: sellers[i].querySelector('.seller-name').textContent.replace('‚úì', '').trim(),
                subject: data.subject,
                bodyPreview: bodyText.substring(0, 200) + '...'
              });
            }
          } catch (error) {
            console.error('Error loading sample data:', error);
          }
        }
        
        const modalHTML = `
          <div class="modal-overlay" onclick="closeModal()">
            <div class="modal-content raw-data-modal" onclick="event.stopPropagation()">
              <h3>üî¢ Raw Data Sample - Manual Verification</h3>
              <div class="manual-checks">
                <h4>‚úÖ What to verify manually:</h4>
                <ul>
                  <li><strong>Seller names match your expectations</strong></li>
                  <li><strong>Email subjects mention correct number of products</strong></li>
                  <li><strong>Prices in email body look reasonable</strong></li>
                  <li><strong>No obvious formatting errors</strong></li>
                </ul>
              </div>
              
              <div class="sample-data">
                ${sampleData.map((sample, index) => `
                  <div class="sample-item">
                    <h4>Sample ${index + 1}: ${sample.seller}</h4>
                    <p><strong>Subject:</strong> <code>${sample.subject}</code></p>
                    <p><strong>Email Start:</strong></p>
                    <div class="code-block">${sample.bodyPreview}</div>
                  </div>
                `).join('')}
              </div>
              
              <div class="verification-tips">
                <h4>üéØ Red Flags to Watch For:</h4>
                <ul>
                  <li>Subject says "1 Product" but you expect multiple</li>
                  <li>Seller names look weird (encoding issues)</li>
                  <li>Prices are extremely high/low (like $0.00 or $99999)</li>
                  <li>Missing product descriptions or SKUs</li>
                </ul>
              </div>
              
              <div class="modal-actions">
                <button onclick="closeModal()" class="close-modal-btn">‚úÖ Looks Good</button>
                <button onclick="closeModal()" class="danger-btn">‚ùå Something Wrong</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // === UX/UI BUTTON HELPERS === 
      function setButtonLoading(button, text = 'Processing...') {
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.textContent = text;
        button.classList.add('btn--loading');
      }

      function setButtonSuccess(button, text) {
        button.classList.remove('btn--loading');
        button.classList.add('btn--success-feedback');
        button.textContent = text;
        
        // Remove feedback class after animation
        setTimeout(() => {
          button.classList.remove('btn--success-feedback');
        }, 600);
      }

      function setButtonError(button) {
        button.classList.remove('btn--loading');
        button.classList.add('btn--error-feedback');
        button.disabled = false;
        button.textContent = button.dataset.originalText || 'Try Again';
        
        // Remove feedback class after animation
        setTimeout(() => {
          button.classList.remove('btn--error-feedback');
        }, 600);
      }

      function showAlert(message, type) {
        const alertHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        document.getElementById("alertContainer").innerHTML = alertHTML;
      }

      function resetPage() {
        location.reload();
      }

      function showUploadSection() {
        // Hide results and show upload section
        results.classList.remove("active");
        uploadSection.style.display = "block";
        
        // Clear the file input
        fileInput.value = "";
        
        // Clear filename display
        const filenameSpan = document.getElementById("currentFilename");
        if (filenameSpan) filenameSpan.textContent = "";
      }

      // Function to update just one seller's data without losing progress
      async function updateSellerData(sellerName) {
        try {
          
          // Get fresh data from server
          const response = await fetch('/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ existing_upload: true })
          });
          
          if (!response.ok) return;
          
          const freshData = await response.json();
          
          // Find the updated seller data
          const updatedSeller = freshData.sellers.find(s => s.name === sellerName);
          if (!updatedSeller) return;
          
          // Update the seller in our cached data
          if (window.lastAnalysisResult && window.lastAnalysisResult.sellers) {
            const sellerIndex = window.lastAnalysisResult.sellers.findIndex(s => s.name === sellerName);
            if (sellerIndex !== -1) {
              window.lastAnalysisResult.sellers[sellerIndex] = updatedSeller;
              
              // Update only this seller's section in the DOM
              const sellerElement = document.querySelector(`[data-seller-name="${CSS.escape(sellerName)}"]`);
              if (sellerElement) {
                // Re-render just this seller's section
                const updatedHTML = createSellerSection(updatedSeller);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = updatedHTML;
                sellerElement.replaceWith(tempDiv.firstElementChild);
              }
            }
          }
          
        } catch (error) {
          console.error(`‚ùå Error updating seller ${sellerName}:`, error);
        }
      }

      // Helper function to create seller section HTML (extracted from displayResults)
      function createSellerSection(seller) {
        // Filter products by day status
        const day1 = seller.products.filter(p => p.day_status === 'DAY_1');
        const day2 = seller.products.filter(p => p.day_status === 'DAY_2');
        const day3 = seller.products.filter(p => p.day_status === 'DAY_3_PLUS');

        // Determine border color class based on process status
        let severityClass = '';
        
        // Check if any DAY 3+ product is in DNS (RED)
        const hasInDNS = day3.some(p => p.in_dns);
        // Check if any DAY 3+ product is pending approval (ORANGE)
        const hasPending = day3.some(p => p.pending_approval);
        
        if (hasInDNS) {
          severityClass = 'has-dns'; // Red - Added to DNS
        } else if (hasPending) {
          severityClass = 'has-day3'; // Orange - Sent to Daniel (pending)
        } else if (day3.length > 0) {
          severityClass = 'has-day3'; // Orange - Ready to escalate
        } else if (day2.length > 0) {
          severityClass = 'has-day2'; // Yellow - Second notice
        } else {
          severityClass = ''; // Blue - Default for DAY 1 (new violations)
        }

        // Helper function to create product HTML
        const createProductHTML = (products) => products.map(product => 
          `<div class="product-item">
            <div class="product-info">
              <div class="product-name">${product.sku} - ${product.description || 'No description'}</div>
              <div class="product-pricing">
                <span class="current-price">Current: $${product.current_price}</span>
                <span class="map-price">MAP: $${product.map_price}</span>
                <span class="violation-amount">Violation: $${(product.map_price - product.current_price).toFixed(2)}</span>
              </div>
            </div>
          </div>`
        ).join('');

        // Helper function to create violation section
        const createViolationSection = ({ products, dayClass, title, dayIndex, sellerName, emailSent, emailDate, revertFunction }) => `
          <div class="violation-section ${dayClass}">
            <div class="section-header">
              <div class="section-header__content">
                <h3 class="section-header__title">${title} (${products.length} items)</h3>
                <div class="section-header__actions">
                  <button class="btn btn--info" onclick="copySubjectByDay('${sellerName}', ${dayIndex}, this)">Copy Subject</button>
                  <button class="btn btn--secondary" onclick="previewEmailByDay('${sellerName}', ${dayIndex})">Preview Email</button>
                  <button class="btn btn--primary" onclick="copyEmailByDay('${sellerName}', ${dayIndex}, this)">Copy Email</button>
                </div>
              </div>
            </div>
            <div class="products-container">
              ${createProductHTML(products)}
            </div>
            <div class="email-section">
              <div class="email-tracking">
                <label class="email-tracking__label">
                  <input type="checkbox" 
                         class="email-tracking__checkbox"
                         ${emailSent > 0 ? 'checked disabled' : ''} 
                         onchange="${dayIndex === 0 ? 'markFirstEmailSent' : 'markSecondEmailSent'}('${sellerName}', this)">
                  <strong>‚úì Mark as sent</strong>
                </label>
                ${emailSent > 0 ? 
                  `<button class="btn btn--danger btn--small" onclick="${revertFunction}('${sellerName}', this)">Undo</button>` : 
                  ''
                }
                <span class="email-status-text">
                  ${emailSent > 0 ? `‚úÖ Sent on ${emailDate || 'Unknown date'}` : 'üìß Not sent yet'}
                </span>
              </div>
            </div>
          </div>
        `;

        let groupedHTML = '';

        // DAY 1 GROUP
        if (day1.length > 0) {
          groupedHTML += createViolationSection({
            products: day1,
            dayClass: 'violation-section--day1',
            title: 'üÜï NEW VIOLATIONS - Day 1',
            dayIndex: 0,
            sellerName: seller.name,
            emailSent: seller.first_emails_sent || 0,
            emailDate: seller.first_email_date,
            revertFunction: 'revertFirstEmail'
          });
        }

        // DAY 2 GROUP
        if (day2.length > 0) {
          groupedHTML += createViolationSection({
            products: day2,
            dayClass: 'violation-section--day2',
            title: '‚ö†Ô∏è SECOND NOTICE - Day 2',
            dayIndex: 1,
            sellerName: seller.name,
            emailSent: seller.second_emails_sent || 0,
            emailDate: seller.second_email_date,
            revertFunction: 'revertSecondEmail'
          });
        }

        // DAY 3+ GROUP with escalation options
        if (day3.length > 0) {
          // Rest of DAY 3 logic...
          groupedHTML += `<div class="violation-section violation-section--day3">
            <div class="section-header">
              <div class="section-header__content">
                <h3 class="section-header__title">ÔøΩ ESCALATION REQUIRED - Day 3+ (${day3.length} items)</h3>
              </div>
            </div>
            <div class="products-container">${createProductHTML(day3)}</div>
          </div>`;
        }

        return `
          <div class="seller-section ${severityClass}" data-seller-name="${seller.name}">
            <div class="seller-header">
              <h3 class="seller-name">${seller.name}${seller.in_dns ? ' <span style="color: #EF4444; font-weight: bold;">üö´ DNS</span>' : ''}</h3>
            </div>
            <div class="seller-contact-row">
              ${seller.contact || 'No contact info'}
            </div>
            ${groupedHTML}
          </div>
        `;
      }
    </script>
  </body>
</html>
